<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="HandheldFriendly" content="true">
    <title>Cricket Chase Analyzer</title>
    <style>
        :root {
            /* Default Theme Variables */
            --background-image: url('https://images.unsplash.com/photo-1593341646782-e0b495cff86d?q=80&w=2070&auto=format&fit=crop');
            --background-color: transparent;
            --primary-color: #ffd700; /* Gold */
            --secondary-color: #00ff00; /* Lime Green */
            --text-color: #fff;
            --container-background: rgba(0, 0, 0, 0.85);
            --button-gradient-start: #00ff00;
            --button-gradient-end: #008000;
            --reset-gradient-start: #ff4500;
            --reset-gradient-end: #d32f2f;
            --download-gradient-start: #1e90ff;
            --download-gradient-end: #4169e1;
            --view-gradient-start: #ffd700;
            --view-gradient-end: #ff8c00;
            --disabled-gradient-start: #808080;
            --disabled-gradient-end: #696969;
            --table-header-bg-start: #008000;
            --table-header-bg-end: #004d00;
            --table-row-even: rgba(255, 255, 255, 0.05);
            --table-row-hover: rgba(255, 215, 0, 0.2);
            --table-row-highlight: rgba(255, 215, 0, 0.4);
            --font-size-base: 16px;
            --font-size-small: 14px;
            --font-size-large: 18px;
            --input-padding: 12px;
            --button-padding: 12px;
            --container-padding: 20px;
        }

        /* Night Match Theme */
        .theme-night {
            --background-image: url('https://images.unsplash.com/photo-1511207538754-e8555f2bc187?q=80&w=1887&auto=format&fit=crop');
            --primary-color: #0000ff; /* Blue */
            --secondary-color: #ffffff; /* White */
            --text-color: #fff;
            --container-background: rgba(0, 0, 0, 0.9);
            --button-gradient-start: #0000ff;
            --button-gradient-end: #00008b;
            --reset-gradient-start: #ff00ff;
            --reset-gradient-end: #8b008b;
            --download-gradient-start: #00b7eb;
            --download-gradient-end: #0077b6;
            --view-gradient-start: #ffffff;
            --view-gradient-end: #d3d3d3;
            --table-header-bg-start: #00008b;
            --table-header-bg-end: #000066;
            --table-row-even: rgba(255, 255, 255, 0.1);
            --table-row-hover: rgba(0, 191, 255, 0.2);
            --table-row-highlight: rgba(0, 191, 255, 0.4);
        }

        /* Historical Theme */
        .theme-historical {
            --background-image: url('https://images.unsplash.com/photo-1600679472829-3044539ce8ed?q=80&w=2070&auto=format&fit=crop');
            --primary-color: #deb887; /* Sepia */
            --secondary-color: #a0522d; /* Brown */
            --text-color: #000;
            --container-background: rgba(255, 245, 238, 0.9); /* Light Sepia */
            --button-gradient-start: #deb887;
            --button-gradient-end: #cd853f;
            --reset-gradient-start: #8b4513;
            --reset-gradient-end: #5c4033;
            --download-gradient-start: #cd853f;
            --download-gradient-end: #8b4513;
            --view-gradient-start: #a0522d;
            --view-gradient-end: #5c4033;
            --table-header-bg-start: #8b4513;
            --table-header-bg-end: #5c4033;
            --table-row-even: rgba(245, 222, 179, 0.5);
            --table-row-hover: rgba(205, 133, 63, 0.3);
            --table-row-highlight: rgba(205, 133, 63, 0.5);
        }

        /* Vibrant Theme */
        .theme-vibrant {
            --background-image: url('https://images.unsplash.com/photo-1551969014-7d2c4cddf0b6?q=80&w=1932&auto=format&fit=crop');
            --primary-color: #ff69b4; /* Hot Pink */
            --secondary-color: #8a2be2; /* Blue Violet */
            --text-color: #fff;
            --container-background: rgba(0, 0, 0, 0.85);
            --button-gradient-start: #ff69b4;
            --button-gradient-end: #ff1493;
            --reset-gradient-start: #ff00ff;
            --reset-gradient-end: #c71585;
            --download-gradient-start: #8a2be2;
            --download-gradient-end: #4b0082;
            --view-gradient-start: #ff1493;
            --view-gradient-end: #c71585;
            --table-header-bg-start: #8a2be2;
            --table-header-bg-end: #4b0082;
            --table-row-even: rgba(255, 255, 255, 0.05);
            --table-row-hover: rgba(255, 20, 147, 0.2);
            --table-row-highlight: rgba(255, 20, 147, 0.4);
        }

        /* Minimalist Theme */
        .theme-minimalist {
            --background-image: none;
            --background-color: #d3d3d3; /* Light Gray */
            --primary-color: #808080; /* Gray */
            --secondary-color: #ffffff; /* White */
            --text-color: #000;
            --container-background: rgba(255, 255, 255, 0.95);
            --button-gradient-start: #808080;
            --button-gradient-end: #696969;
            --reset-gradient-start: #ff6347;
            --reset-gradient-end: #dc143c;
            --download-gradient-start: #4682b4;
            --download-gradient-end: #2f4f4f;
            --view-gradient-start: #a9a9a9;
            --view-gradient-end: #696969;
            --table-header-bg-start: #696969;
            --table-header-bg-end: #2f4f4f;
            --table-row-even: rgba(211, 211, 211, 0.5);
            --table-row-hover: rgba(169, 169, 169, 0.3);
            --table-row-highlight: rgba(169, 169, 169, 0.5);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--background-color) var(--background-image) no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
            color: var(--text-color);
            font-size: var(--font-size-base);
            line-height: 1.5;
            padding: 10px;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 100%;
            width: 100%;
            margin: 10px 0;
            background: var(--container-background);
            padding: var(--container-padding);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3), inset 0 0 10px rgba(255, 215, 0, 0.2);
            border: 1px solid var(--primary-color);
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        h1 {
            color: var(--primary-color);
            font-size: 1.8em;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7), 0 0 10px var(--secondary-color);
            animation: glow 2s infinite alternate;
            text-align: center;
            word-break: break-word;
        }

        @keyframes glow {
            0% { text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7), 0 0 10px var(--secondary-color); }
            100% { text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.9), 0 0 15px var(--primary-color); }
        }

        #themeSelect {
            padding: var(--input-padding);
            font-size: var(--font-size-base);
            border-radius: 5px;
            border: 1px solid var(--primary-color);
            background: rgba(0, 0, 0, 0.5);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        #themeSelect:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 8px var(--secondary-color);
            outline: none;
        }

        label {
            display: block;
            margin: 8px 0 4px;
            font-weight: 600;
            font-size: var(--font-size-base);
            color: var(--secondary-color);
            text-shadow: 0 0 3px rgba(0, 255, 0, 0.3);
        }

        input, select {
            width: 100%;
            padding: var(--input-padding);
            margin-bottom: 15px;
            font-size: var(--font-size-base);
            border-radius: 5px;
            border: 1px solid var(--primary-color);
            background: rgba(0, 0, 0, 0.5);
            color: var(--text-color);
            transition: all 0.2s ease;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.2);
            -webkit-appearance: none;
        }

        input:focus, select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 10px var(--secondary-color);
            outline: none;
        }

        select {
            background: rgba(0, 0, 0, 0.5) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="6"><polygon points="0,0 12,0 6,6" fill="%23ffd700"/></svg>') no-repeat right 10px center;
            background-size: 12px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        button {
            padding: var(--button-padding);
            background: linear-gradient(135deg, var(--button-gradient-start), var(--button-gradient-end));
            color: var(--text-color);
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: var(--font-size-base);
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 3px 8px rgba(0, 255, 0, 0.3);
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        button::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.15);
            transform: rotate(30deg);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        button:hover::after, button:focus::after {
            top: 100%;
            left: 100%;
        }

        button:hover, button:focus {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 255, 0, 0.4);
        }

        #resetBtn {
            background: linear-gradient(135deg, var(--reset-gradient-start), var(--reset-gradient-end));
        }

        #downloadBtn {
            background: linear-gradient(135deg, var(--download-gradient-start), var(--download-gradient-end));
        }

        #viewDetailsBtn {
            background: linear-gradient(135deg, var(--view-gradient-start), var(--view-gradient-end));
        }

        #viewDetailsBtn:disabled, #downloadBtn:disabled {
            background: linear-gradient(135deg, var(--disabled-gradient-start), var(--disabled-gradient-end));
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        #viewDetailsBtn:disabled::after, #downloadBtn:disabled::after {
            display: none;
        }

        #output {
            background: var(--container-background);
            padding: 15px;
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            min-height: 200px;
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: auto;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2), inset 0 0 8px rgba(255, 215, 0, 0.1);
            color: var(--text-color);
            font-size: var(--font-size-small);
            animation: slideIn 0.3s ease-out;
            -webkit-overflow-scrolling: touch;
        }

        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin: 10px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-small);
            background: rgba(0, 0, 0, 0.3);
            min-width: 600px;
        }

        th, td {
            border: 1px solid var(--primary-color);
            padding: 8px;
            text-align: left;
            color: var(--text-color);
            word-break: break-word;
        }

        th {
            background: linear-gradient(135deg, var(--table-header-bg-start), var(--table-header-bg-end));
            color: var(--primary-color);
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 1;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.7);
            font-size: var(--font-size-small);
        }

        th:hover {
            background: linear-gradient(135deg, var(--table-header-bg-end), var(--table-header-bg-start));
        }

        tr:nth-child(even) {
            background: var(--table-row-even);
        }

        tr:hover {
            background: var(--table-row-hover);
            transition: background 0.2s ease;
        }

        tr.highlight {
            background: var(--table-row-highlight);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--primary-color);
            margin: 10px 0;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }

        .filter-group select, .year-filter-btn {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            color: var(--text-color);
        }

        .year-filter-btn {
            background: linear-gradient(135deg, var(--download-gradient-start), var(--download-gradient-end));
            border: none;
            padding: var(--button-padding);
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            margin: 5px 0;
        }

        .year-filter-btn:hover, .year-filter-btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(30, 144, 255, 0.4);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
            padding: 10px;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--container-background);
            padding: 15px;
            border-radius: 10px;
            width: 100%;
            max-width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(255, 215, 0, 0.2);
            border: 1px solid var(--primary-color);
            color: var(--text-color);
            animation: zoomIn 0.3s ease-out;
            -webkit-overflow-scrolling: touch;
        }

        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-content h2 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
            color: var(--primary-color);
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        .year-checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            font-size: var(--font-size-base);
            cursor: pointer;
            color: var(--secondary-color);
            text-shadow: 0 0 3px rgba(0, 255, 0, 0.3);
        }

        .year-checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .modal-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            width: auto;
            min-width: 80px;
            padding: 8px 12px;
            font-size: var(--font-size-small);
        }

        /* Responsive adjustments */
        @media (min-width: 400px) {
            :root {
                --font-size-base: 17px;
                --font-size-small: 15px;
                --input-padding: 14px;
                --button-padding: 14px;
                --container-padding: 25px;
            }
            
            .container {
                width: 95%;
                margin: 15px auto;
            }
            
            .button-group {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            button {
                flex: 1 1 45%;
                min-width: 120px;
            }
            
            .filter-group {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .filter-group select, .year-filter-btn {
                flex: 1 1 45%;
            }
        }

        @media (min-width: 600px) {
            :root {
                --font-size-base: 18px;
                --font-size-small: 16px;
                --font-size-large: 20px;
                --input-padding: 15px;
                --button-padding: 15px;
                --container-padding: 30px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            #themeSelect {
                width: auto;
                max-width: 200px;
                margin-bottom: 0;
            }
            
            .container {
                max-width: 90%;
            }
            
            button {
                flex: 1;
            }
            
            .filter-group select, .year-filter-btn {
                flex: 1;
            }
            
            .modal-content {
                max-width: 80%;
                padding: 20px;
            }
        }

        @media (min-width: 768px) {
            body {
                align-items: center;
                padding: 20px;
            }
            
            .container {
                max-width: 800px;
            }
            
            #output {
                max-height: 50vh;
            }
            
            .table-container {
                max-height: 45vh;
            }
        }

        @media (min-width: 992px) {
            .container {
                max-width: 900px;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) {
            button:hover {
                transform: none;
                box-shadow: 0 3px 8px rgba(0, 255, 0, 0.3);
            }
            
            button:active {
                transform: translateY(2px);
                box-shadow: 0 1px 3px rgba(0, 255, 0, 0.2);
            }
            
            th:hover {
                background: linear-gradient(135deg, var(--table-header-bg-start), var(--table-header-bg-end));
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white !important;
                color: black !important;
                padding: 0;
            }
            
            .container {
                background: white !important;
                color: black !important;
                box-shadow: none !important;
                border: none !important;
                padding: 10px !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            #themeSelect, .button-group, .filter-group {
                display: none !important;
            }
            
            #output {
                max-height: none !important;
                overflow: visible !important;
                box-shadow: none !important;
                border: none !important;
                page-break-inside: avoid;
            }
            
            .table-container {
                max-height: none !important;
                overflow: visible !important;
                page-break-inside: avoid;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body class="theme-default">
    <div class="container">
        <div class="header">
            <h1>Cricket Chase Analyzer</h1>
            <select id="themeSelect" onchange="changeTheme()">
                <option value="theme-default">Default</option>
                <option value="theme-night">Night Match</option>
                <option value="theme-historical">Historical</option>
                <option value="theme-vibrant">Vibrant</option>
                <option value="theme-minimalist">Minimalist</option>
            </select>
        </div>
        
        <label for="fileInput">Upload Excel File:</label>
        <input type="file" id="fileInput" accept=".xlsx, .xls">
        
        <label for="scoreInput">Score/Wickets (e.g., 20/1):</label>
        <input type="text" id="scoreInput" placeholder="Enter score/wickets" inputmode="numeric">
        
        <label for="runTolerance">Run Tolerance (±):</label>
        <input type="number" id="runTolerance" value="5" min="0" max="20" inputmode="numeric">
        
        <label for="wicketTolerance">Wicket Tolerance (±):</label>
        <input type="number" id="wicketTolerance" value="1" min="0" max="3" inputmode="numeric">
        
        <label for="overSelect">Select Over:</label>
        <select id="overSelect">
            <option value="">-- Select Over --</option>
        </select>
        
        <label for="rangeSelect">20-Over Score Range (Optional):</label>
        <select id="rangeSelect">
            <option value="">-- All Ranges --</option>
            <option value="120-129">120-129</option>
            <option value="130-139">130-139</option>
            <option value="140-149">140-149</option>
            <option value="150-159">150-159</option>
            <option value="160-169">160-169</option>
            <option value="170-179">170-179</option>
            <option value="180-189">180-189</option>
            <option value="190-199">190-199</option>
            <option value="200+">200+</option>
        </select>
        
        <div class="button-group">
            <button onclick="processInput()">Submit</button>
            <button id="resetBtn" onclick="resetForm()">Reset</button>
            <button id="downloadBtn" onclick="downloadResults()" disabled>Download Results</button>
            <button id="viewDetailsBtn" onclick="viewFullMatchDetails()" disabled>View Full Details</button>
        </div>
        
        <div id="output">Upload your Excel file to start.</div>
    </div>

    <div id="yearFilterModal" class="modal">
        <div class="modal-content">
            <h2>Select Years</h2>
            <div id="yearCheckboxes"></div>
            <div class="modal-buttons">
                <button onclick="applyYearFilter()">OK</button>
                <button onclick="closeYearFilterModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="fullDetailsModal" class="modal">
        <div class="modal-content">
            <h2>Full Match Details</h2>
            <div id="fullDetailsOutput" class="table-container"></div>
            <div class="modal-buttons">
                <button onclick="closeFullDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" 
            onerror="alert('Failed to load SheetJS. Check internet or use a local copy.');"></script>
    <script>
        let matches = [];
        let filteredMatches = [];
        let firstInningsDone = false;
        let scoreRange = null;
        let targetRuns = null;
        let lastData = null;
        let allYears = [];
        let allScoreRanges = [];
        let selectedYears = [];

        const overSelect = document.getElementById('overSelect');

        function populateOverSelect() {
            overSelect.innerHTML = '<option value="">-- Select Over --</option>';
            for (let i = 1; i <= 40; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = `${i}th Over`;
                overSelect.appendChild(option);
            }
        }
        populateOverSelect();

        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) {
                alert('No file selected.');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    matches = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    filteredMatches = matches;
                    document.getElementById('output').textContent = `File loaded successfully! ${matches.length} matches found.`;
                    console.log("Loaded matches:", matches);
                } catch (err) {
                    alert('Error loading file: ' + err.message);
                    document.getElementById('output').textContent = "Error loading file: " + err.message;
                }
            };
            reader.onerror = function() {
                alert('Failed to read file.');
            };
            reader.readAsArrayBuffer(file);
        });

        function changeTheme() {
            const theme = document.getElementById('themeSelect').value;
            document.body.className = theme;
        }

        function parseScore(scoreWickets) {
            const parts = scoreWickets.split('/');
            if (parts.length !== 2) return [null, null];
            const runs = parseInt(parts[0]);
            const wickets = parseInt(parts[1]);
            if (isNaN(runs) || isNaN(wickets) || wickets < 0 || wickets > 10) return [null, null];
            return [runs, wickets];
        }

        function parseRange(rangeStr) {
            if (!rangeStr) return null;
            if (rangeStr === "200+") return [200, Infinity];
            const [min, max] = rangeStr.split('-').map(Number);
            return [min, max];
        }

        function calculateDifference(scoreLater, scoreEarlier) {
            if (!scoreLater || !scoreEarlier) return "N/A";
            const [runsLater, wicketsLater] = scoreLater.split('/').map(Number);
            const [runsEarlier, wicketsEarlier] = scoreEarlier.split('/').map(Number);
            const runDiff = runsLater - runsEarlier;
            const wicketDiff = wicketsLater - wicketsEarlier;
            return `${runDiff}/${wicketDiff}`;
        }

        function calculateProbabilities(data) {
            const validResults = data.filter(row => 
                row.Result.toLowerCase() === 'chased' || row.Result.toLowerCase() === 'defend'
            );
            const totalValid = validResults.length;
            if (totalValid === 0) return { chased: 0, defend: 0 };
            const chasedCount = validResults.filter(row => row.Result.toLowerCase() === 'chased').length;
            const defendCount = validResults.filter(row => row.Result.toLowerCase() === 'defend').length;
            return {
                chased: totalValid > 0 ? (chasedCount / totalValid * 100).toFixed(2) : 0,
                defend: totalValid > 0 ? (defendCount / totalValid * 100).toFixed(2) : 0
            };
        }

        function isSimilarScore(histRuns, histWickets, targetRuns, targetWickets, runTolerance, wicketTolerance) {
            return Math.abs(histRuns - targetRuns) <= runTolerance && Math.abs(histWickets - targetWickets) <= wicketTolerance;
        }

        function openYearFilterModal() {
            const modal = document.getElementById('yearFilterModal');
            const checkboxesDiv = document.getElementById('yearCheckboxes');
            let html = '';
            allYears.forEach(year => {
                const isChecked = selectedYears.length === 0 || selectedYears.includes(year.toString());
                html += `<label class="year-checkbox-label"><input type="checkbox" class="year-checkbox" value="${year}" ${isChecked ? 'checked' : ''}>${year}</label>`;
            });
            checkboxesDiv.innerHTML = html;
            modal.style.display = 'flex';
        }

        function closeYearFilterModal() {
            document.getElementById('yearFilterModal').style.display = 'none';
        }

        function applyYearFilter() {
            const yearCheckboxes = document.querySelectorAll('.year-checkbox:checked');
            selectedYears = Array.from(yearCheckboxes).map(cb => cb.value);
            closeYearFilterModal();
            applyFilters();
        }

        function processInput() {
            const scoreWickets = document.getElementById('scoreInput').value.trim();
            const over = parseInt(document.getElementById('overSelect').value);
            const runTolerance = parseInt(document.getElementById('runTolerance').value);
            const wicketTolerance = parseInt(document.getElementById('wicketTolerance').value);
            const rangeStr = document.getElementById('rangeSelect').value;
            const [runs, wickets] = parseScore(scoreWickets);
            const output = document.getElementById('output');

            if (!scoreWickets || isNaN(over) || runs === null || wickets === null) {
                output.textContent = "Please enter valid score/wickets (e.g., '20/1') and select an over.";
                return;
            }
            if (matches.length === 0) {
                output.textContent = "Please upload an Excel file first.";
                return;
            }

            let compareData = matches;
            const selectedRange = parseRange(rangeStr);
            const overKey = `${over}over`;

            if (over <= 20) {
                if (over === 20) {
                    firstInningsDone = true;
                    targetRuns = runs;
                    scoreRange = selectedRange || getScoreRange(runs);
                }
            } else {
                if (!firstInningsDone) {
                    const targetInput = prompt("Please enter the final score after 20 overs (e.g., '142/3'):");
                    if (!targetInput) {
                        output.textContent = "Target score required for 2nd innings analysis.";
                        return;
                    }
                    const [targetRunsInput, targetWickets] = parseScore(targetInput);
                    if (targetRunsInput === null || targetWickets === null) {
                        output.textContent = "Invalid target score format. Use 'runs/wickets' (e.g., '142/3').";
                        return;
                    }
                    firstInningsDone = true;
                    targetRuns = targetRunsInput;
                    scoreRange = selectedRange || getScoreRange(targetRuns);
                }
                compareData = filteredMatches;
            }

            if (selectedRange) {
                compareData = compareData.filter(match => {
                    const score = match['20over'];
                    if (!score) return false;
                    const [matchRuns] = score.split('/').map(Number);
                    return matchRuns >= selectedRange[0] && (selectedRange[1] === Infinity ? true : matchRuns <= selectedRange[1]);
                });
                scoreRange = selectedRange;
            } else if (over > 20 && scoreRange) {
                compareData = compareData.filter(match => {
                    const score = match['20over'];
                    if (!score) return false;
                    const [matchRuns] = score.split('/').map(Number);
                    return matchRuns >= scoreRange[0] && (selectedRange[1] === Infinity ? true : matchRuns <= selectedRange[1]);
                });
            }

            const yearMatches = {};
            let totalMatches = 0;
            let runDifference = null;

            if (over <= 20) {
                compareData.forEach((match, index) => {
                    const score = match[overKey];
                    if (!score) return;
                    const [histRuns, histWickets] = score.split('/').map(Number);
                    if (isSimilarScore(histRuns, histWickets, runs, wickets, runTolerance, wicketTolerance)) {
                        const year = match['year'];
                        if (!yearMatches[year]) yearMatches[year] = [];
                        yearMatches[year].push({ match, index });
                        totalMatches++;
                    }
                });
            } else {
                runDifference = targetRuns - runs;
                compareData.forEach((match, index) => {
                    const twentyOverScore = match['20over'];
                    const currentOverScore = match[overKey];
                    if (twentyOverScore && currentOverScore) {
                        const [twentyRuns] = twentyOverScore.split('/').map(Number);
                        const [currentRuns] = currentOverScore.split('/').map(Number);
                        if (twentyRuns - currentRuns === runDifference) {
                            const year = match['year'];
                            if (!yearMatches[year]) yearMatches[year] = [];
                            yearMatches[year].push({ match, index });
                            totalMatches++;
                        }
                    }
                });
            }

            allYears = [...new Set(Object.keys(yearMatches).map(Number))].sort((a, b) => a - b);
            allScoreRanges = [];
            compareData.forEach(match => {
                const score = match['20over'];
                if (score) {
                    const [runs] = score.split('/').map(Number);
                    const range = getScoreRange(runs);
                    const rangeStr = range[1] === Infinity ? '200+' : `${range[0]}-${range[1]}`;
                    if (!allScoreRanges.includes(rangeStr)) allScoreRanges.push(rangeStr);
                }
            });
            allScoreRanges.sort((a, b) => {
                if (a === '200+') return 1;
                if (b === '200+') return -1;
                return parseInt(a.split('-')[0]) - parseInt(b.split('-')[0]);
            });

            let html = `<p>Analysis for ${runs}/${wickets} after Over ${over} (±${runTolerance} runs, ±${wicketTolerance} wickets)<br>`;
            if (over > 20 || selectedRange) {
                html += `20-Over Score Range: ${rangeStr || `${scoreRange[0]}-${scoreRange[1] === Infinity ? '200+' : scoreRange[1]}`}<br>`;
            }
            if (over > 20 && runDifference !== null) {
                html += `Run Difference (20ov - ${over}ov): ${runDifference}<br>`;
            }
            html += `Total matches: ${totalMatches}</p>`;

            if (totalMatches === 0) {
                html += `<p>No matches found within tolerance after Over ${over}${selectedRange ? ` within ${rangeStr}` : ''}.</p>`;
            } else {
                html += '<div class="filter-group">';
                html += '<button class="year-filter-btn" onclick="openYearFilterModal()">Filter Years</button>';
                html += '<label for="scoreRangeFilter">Filter Score Range:</label>';
                html += '<select id="scoreRangeFilter" onchange="applyFilters()"><option value="">All Score Ranges</option>';
                allScoreRanges.forEach(range => html += `<option value="${range}">${range}</option>`);
                html += '</select>';
                html += '<label for="resultFilter">Filter Result:</label>';
                html += '<select id="resultFilter" onchange="applyFilters()"><option value="">All Results</option><option value="chased">Chased</option><option value="defend">Defend</option></select>';
                html += '</div>';

                html += '<div class="table-container"><table><thead><tr>';
                const headers = over <= 20 ? 
                    ["Year", ...(over < 6 ? ["6ov"] : []), ...(over < 10 ? ["10ov"] : []), ...(over < 15 ? ["15ov"] : []), "20ov", "Result"] :
                    ["Year", ...(over < 26 ? ["26ov"] : []), ...(over < 30 ? ["30ov"] : []), ...(over < 35 ? ["35ov"] : []), `${over}ov`, "20ov", "40ov", "15ov-6ov", "20ov-6ov", "Result"];
                
                headers.forEach(header => html += `<th>${header}</th>`);
                html += '</tr></thead><tbody id="tableBody">';

                const sortedRows = [];
                Object.keys(yearMatches).sort().forEach(year => {
                    yearMatches[year].forEach(({ match }) => {
                        sortedRows.push({ year, match });
                    });
                });

                sortedRows.sort((a, b) => a.year - b.year);
                lastData = [];
                selectedYears = allYears.map(String);

                sortedRows.forEach(({ year, match }) => {
                    const rowData = { Year: year, originalMatch: match };
                    if (over <= 20) {
                        if (over < 6) rowData['6ov'] = match['6over'] || "N/A";
                        if (over < 10) rowData['10ov'] = match['10over'] || "N/A";
                        if (over < 15) rowData['15ov'] = match['15over'] || "N/A";
                        rowData['20ov'] = match['20over'] || "N/A";
                        rowData['Result'] = match['result'] || "unknown";
                    } else {
                        if (over < 26) rowData['26ov'] = match['26over'] || "N/A";
                        if (over < 30) rowData['30ov'] = match['30over'] || "N/A";
                        if (over < 35) rowData['35ov'] = match['35over'] || "N/A";
                        rowData[`${over}ov`] = match[overKey] || "N/A";
                        rowData['20ov'] = match['20over'] || "N/A";
                        rowData['40ov'] = match['40over'] || "N/A";
                        rowData['15ov-6ov'] = calculateDifference(match['15over'], match['6over']);
                        rowData['20ov-6ov'] = calculateDifference(match['20over'], match['6over']);
                        rowData['Result'] = match['result'] || "unknown";
                    }
                    lastData.push(rowData);
                });

                html += generateTableRows(lastData, over, runs, wickets);
                html += '</tbody></table></div>';

                const probabilities = calculateProbabilities(lastData);
                html += `<p>Probability of Chased: ${probabilities.chased}% | Probability of Defend: ${probabilities.defend}%</p>`;
            }

            output.innerHTML = html;
            document.getElementById('downloadBtn').disabled = totalMatches === 0;
            document.getElementById('viewDetailsBtn').disabled = totalMatches === 0;
            addSortFunctionality();
        }

        function generateTableRows(data, over, runs, wickets) {
            let html = '';
            data.forEach(row => {
                const overKey = `${over}ov`;
                const isMatch = over <= 20 && row[overKey] && isSimilarScore(
                    ...row[overKey].split('/').map(Number), runs, wickets,
                    parseInt(document.getElementById('runTolerance').value),
                    parseInt(document.getElementById('wicketTolerance').value)
                );
                html += `<tr ${isMatch ? 'class="highlight"' : ''}>`;
                Object.entries(row).forEach(([key, value]) => {
                    if (key !== 'originalMatch') html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            return html;
        }

        function applyFilters() {
            const scoreRangeFilter = document.getElementById('scoreRangeFilter').value;
            const resultFilter = document.getElementById('resultFilter').value;
            const [runs, wickets] = parseScore(document.getElementById('scoreInput').value);
            const over = parseInt(document.getElementById('overSelect').value);
            const filteredData = lastData.filter(row => {
                const yearMatch = selectedYears.length === 0 || selectedYears.includes(row.Year.toString());
                const rangeMatch = !scoreRangeFilter || (() => {
                    const [runs] = (row['20ov'] || '0/0').split('/').map(Number);
                    const range = parseRange(scoreRangeFilter);
                    return runs >= range[0] && (range[1] === Infinity ? true : runs <= range[1]);
                })();
                const resultMatch = !resultFilter || row.Result.toLowerCase() === resultFilter;
                return yearMatch && rangeMatch && resultMatch;
            });
            document.getElementById('tableBody').innerHTML = generateTableRows(filteredData, over, runs, wickets);
            const probabilities = calculateProbabilities(filteredData);
            const output = document.getElementById('output');
            output.innerHTML = output.innerHTML.split('<p>Probability')[0] + 
                `<p>Probability of Chased: ${probabilities.chased}% | Probability of Defend: ${probabilities.defend}%</p>`;
            document.getElementById('viewDetailsBtn').disabled = filteredData.length === 0;
            addSortFunctionality();
        }

        function addSortFunctionality() {
            const table = document.querySelector('#output table');
            if (!table) return;

            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const isAscending = header.dataset.sort !== 'asc';
                    
                    rows.sort((a, b) => {
                        const aValue = a.cells[index].textContent;
                        const bValue = b.cells[index].textContent;
                        
                        if (header.textContent === 'Year') {
                            return isAscending ? 
                                Number(aValue) - Number(bValue) : 
                                Number(bValue) - Number(aValue);
                        }
                        
                        if (aValue.includes('/') && bValue.includes('/')) {
                            const [runsA] = aValue.split('/').map(Number);
                            const [runsB] = bValue.split('/').map(Number);
                            return isAscending ? runsA - runsB : runsB - runsA;
                        }
                        
                        return isAscending ? 
                            aValue.localeCompare(bValue) : 
                            bValue.localeCompare(aValue);
                    });

                    headers.forEach(h => delete h.dataset.sort);
                    header.dataset.sort = isAscending ? 'asc' : 'desc';
                    
                    tbody.innerHTML = '';
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }

        function resetForm() {
            matches = [];
            filteredMatches = [];
            firstInningsDone = false;
            scoreRange = null;
            targetRuns = null;
            lastData = null;
            allYears = [];
            allScoreRanges = [];
            selectedYears = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('scoreInput').value = '';
            document.getElementById('overSelect').value = '';
            document.getElementById('rangeSelect').value = '';
            document.getElementById('runTolerance').value = '5';
            document.getElementById('wicketTolerance').value = '1';
            document.getElementById('output').textContent = "Upload your Excel file to start.";
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('viewDetailsBtn').disabled = true;
            populateOverSelect();
        }

        function downloadResults() {
            if (!lastData) return;

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(lastData);
            XLSX.utils.book_append_sheet(wb, ws, "Results");
            XLSX.writeFile(wb, `Cricket_Analysis_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function getScoreRange(runs) {
            if (runs >= 200) return [200, Infinity];
            const rangeStart = Math.floor(runs / 10) * 10;
            return [rangeStart, rangeStart + 9];
        }

        function viewFullMatchDetails() {
            const modal = document.getElementById('fullDetailsModal');
            const outputDiv = document.getElementById('fullDetailsOutput');
            if (!lastData || lastData.length === 0) {
                outputDiv.textContent = "No data available.";
                modal.style.display = 'flex';
                return;
            }

            const scoreRangeFilter = document.getElementById('scoreRangeFilter').value;
            const resultFilter = document.getElementById('resultFilter').value;
            const filteredData = lastData.filter(row => {
                const yearMatch = selectedYears.length === 0 || selectedYears.includes(row.Year.toString());
                const rangeMatch = !scoreRangeFilter || (() => {
                    const [runs] = (row['20ov'] || '0/0').split('/').map(Number);
                    const range = parseRange(scoreRangeFilter);
                    return runs >= range[0] && (range[1] === Infinity ? true : runs <= range[1]);
                })();
                const resultMatch = !resultFilter || row.Result.toLowerCase() === resultFilter;
                return yearMatch && rangeMatch && resultMatch;
            });

            if (filteredData.length === 0) {
                outputDiv.textContent = "No matches match the current filters.";
                modal.style.display = 'flex';
                return;
            }

            const allKeys = [...new Set(filteredData.flatMap(row => Object.keys(row.originalMatch)))];

            let html = '<table><thead><tr>';
            allKeys.forEach(key => html += `<th>${key}</th>`);
            html += '</tr></thead><tbody>';

            filteredData.forEach(row => {
                html += '<tr>';
                allKeys.forEach(key => {
                    const value = row.originalMatch[key] !== undefined ? row.originalMatch[key] : "N/A";
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            outputDiv.innerHTML = html;
            modal.style.display = 'flex';

            addModalSortFunctionality();
        }

        function addModalSortFunctionality() {
            const table = document.querySelector('#fullDetailsOutput table');
            if (!table) return;

            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const isAscending = header.dataset.sort !== 'asc';
                    
                    rows.sort((a, b) => {
                        const aValue = a.cells[index].textContent;
                        const bValue = b.cells[index].textContent;
                        
                        if (header.textContent === 'year') {
                            return isAscending ? 
                                Number(aValue) - Number(bValue) : 
                                Number(bValue) - Number(aValue);
                        }
                        
                        if (aValue.includes('/') && bValue.includes('/')) {
                            const [runsA] = aValue.split('/').map(Number);
                            const [runsB] = bValue.split('/').map(Number);
                            return isAscending ? runsA - runsB : runsB - runsA;
                        }
                        
                        return isAscending ? 
                            aValue.localeCompare(bValue) : 
                            bValue.localeCompare(aValue);
                    });

                    headers.forEach(h => delete h.dataset.sort);
                    header.dataset.sort = isAscending ? 'asc' : 'desc';
                    
                    tbody.innerHTML = '';
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }

        function closeFullDetailsModal() {
            document.getElementById('fullDetailsModal').style.display = 'none';
        }
    </script>
</body>
</html>
