<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>CricketBettingTips</title>
    <style>
        body {
            font-family: 'Poppins', Arial, sans-serif;
            margin: 0;
            padding: 15px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background 0.3s, color 0.3s;
        }
        body.classic-mode {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #1a1a1a;
        }
        body.dark-mode {
            background: #1f1f1f;
            color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex-grow: 1;
            box-sizing: border-box;
            position: relative;
            background: rgba(255, 255, 255, 0.9);
        }
        body.classic-mode .container {
            background: rgba(255, 255, 255, 0.95);
            color: #1a1a1a;
        }
        body.dark-mode .container {
            background: #2a2a2a;
            color: #f0f0f0;
        }
        .container > * {
            margin-bottom: 15px;
        }
        h1 {
            text-align: center;
            margin: 0 0 20px 0;
        }
        #liveScore, #output, #match-output {
            padding: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.8);
            box-sizing: border-box;
        }
        body.dark-mode #liveScore, body.dark-mode #output, body.dark-mode #match-output {
            background: rgba(50, 50, 50, 0.8);
            color: #f0f0f0;
        }
        #matchSelect {
            padding: 12px;
            font-size: 1em;
            border-radius: 8px;
            border: 2px solid #ccc;
            background: #fafafa;
            width: 100%;
            margin-bottom: 12px;
        }
        body.dark-mode #matchSelect {
            border-color: #555;
            background: #3a3a3a;
            color: #f0f0f0;
        }
        #matchSelect:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 6px rgba(42, 82, 152, 0.6);
        }
        body.dark-mode #matchSelect:focus {
            border-color: #ffffff;
            box-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
        }
        label {
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .button-group button {
            padding: 10px 20px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            background: #2a5298;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }
        .button-group button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .button-group button:hover:not(:disabled) {
            background: #1e3c72;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }
        body.dark-mode .modal-content {
            background: #2a2a2a;
            color: #f0f0f0;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .modal-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .modal-buttons button:first-child {
            background: #2a5298;
            color: white;
        }
        .modal-buttons button:last-child {
            background: #cccccc;
        }
        .theme-toggle {
            display: flex;
            justify-content: flex-end;
        }
        .theme-toggle select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background: #fafafa;
        }
        body.dark-mode .theme-toggle select {
            background: #3a3a3a;
            color: #f0f0f0;
            border-color: #555;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body class="classic-mode">
    <div id="chase-analyzer">
        <div class="container">
            <div class="theme-toggle">
                <select id="themeSelect" onchange="toggleTheme()">
                    <option value="classic-mode">Classic Mode</option>
                    <option value="dark-mode">Dark Mode</option>
                </select>
            </div>
            <h1>Cricket Chase Analyzer</h1>
            <select id="matchSelect" onchange="selectMatch(this.value)">
                <option value="">-- Select Live Match --</option>
            </select>
            <div id="liveScore">Live Score: Waiting for match selection...</div>
            <label for="rangeSelect">20-Over Score Range (Optional):</label>
            <select id="rangeSelect">
                <option value="">-- All Ranges --</option>
                <option value="120-129">120-129</option>
                <option value="130-139">130-139</option>
                <option value="140-149">140-149</option>
                <option value="150-159">150-159</option>
                <option value="160-169">160-169</option>
                <option value="170-179">170-179</option>
                <option value="180-189">180-189</option>
                <option value="190-199">190-199</option>
                <option value="200+">200+</option>
            </select>
            <div class="button-group">
                <button onclick="viewChaseFullMatchDetails()" id="viewDetailsBtn" disabled>View Full Match Details</button>
                <button onclick="showMatchAnalyzer()">Go to Cricket Match Analyzer</button>
            </div>
            <div id="output">Loading data from GitHub...</div>
        </div>
        <div id="yearFilterModal" class="modal">
            <div class="modal-content">
                <h2>Select Years</h2>
                <div id="yearCheckboxes"></div>
                <div class="modal-buttons">
                    <button onclick="applyChaseYearFilter()">OK</button>
                    <button onclick="closeChaseYearFilterModal()">Cancel</button>
                </div>
            </div>
        </div>
        <div id="fullDetailsModal" class="modal">
            <div class="modal-content">
                <h2>Full Match Details</h2>
                <div id="fullDetailsOutput" class="table-container"></div>
                <div class="modal-buttons">
                    <button onclick="closeChaseFullDetailsModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="match-analyzer" style="display: none;">
        <div class="container">
            <div class="theme-toggle">
                <select id="matchThemeSelect" onchange="toggleTheme()">
                    <option value="classic-mode">Classic Mode</option>
                    <option value="dark-mode">Dark Mode</option>
                </select>
            </div>
            <h1>Cricket Match Analyzer</h1>
            <select id="matchSelect" onchange="selectMatch(this.value)">
                <option value="">-- Select Live Match --</option>
            </select>
            <div id="liveScore">Live Score: Waiting for match selection...</div>
            <div class="button-group">
                <button id="matchSubmitBtn" onclick="viewMatchFullMatchDetails()" disabled>View Full Details</button>
                <button id="matchBackBtn" onclick="showChaseAnalyzer()">Back to Cricket Chase Analyzer</button>
            </div>
            <div id="match-output">Loading data from GitHub...</div>
        </div>
        <div id="matchYearFilterModal" class="modal">
            <div class="modal-content">
                <h2>Select Years</h2>
                <div id="matchYearCheckboxes"></div>
                <div class="modal-buttons">
                    <button onclick="applyMatchYearFilter()">OK</button>
                    <button onclick="closeMatchYearFilterModal()">Cancel</button>
                </div>
            </div>
        </div>
        <div id="matchFullDetailsModal" class="modal">
            <div class="modal-content">
                <h2>Full Match Details</h2>
                <div id="matchFullDetailsOutput" class="table-container"></div>
                <div class="modal-buttons">
                    <button onclick="closeMatchFullDetailsModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        const API_KEY = '30d18c38-1bc2-4161-a60b-8261de9e5e9d';
        let selectedMatchId = null;
        let lastOver = null;
        let lastCompletedRuns = null;
        let lastCompletedWickets = null;
        let matchScores = { '6over': null, '10over': null, '15over': null, '20over': null };
        let currentInnings = 1;
        let chaseFirstInningsDone = false;
        let chaseScoreRange = null;
        let chaseTargetRuns = null;

        function toggleTheme() {
            const theme = document.getElementById('themeSelect').value || document.getElementById('matchThemeSelect').value;
            document.body.className = theme;
            localStorage.setItem('theme', theme);
            document.getElementById('themeSelect').value = theme;
            document.getElementById('matchThemeSelect').value = theme;
        }

        function showMatchAnalyzer() {
            document.getElementById('chase-analyzer').style.display = 'none';
            document.getElementById('match-analyzer').style.display = 'block';
            toggleTheme();
            if (selectedMatchId) updateMatchLiveScore();
        }

        function showChaseAnalyzer() {
            document.getElementById('match-analyzer').style.display = 'none';
            document.getElementById('chase-analyzer').style.display = 'block';
            toggleTheme();
            if (selectedMatchId) updateChaseLiveScore();
        }

        let chaseMatches = [];
        let chaseFilteredMatches = [];
        let chaseLastData = [];
        let chaseAllYears = [];
        let chaseAllScoreRanges = [];
        let chaseSelectedYears = [];

        let matchMatches = [];
        let matchLastData = [];
        let matchAllYears = [];
        let matchSelectedYears = [];
        const matchScoreRanges = ['120-129', '130-139', '140-149', '150-159', '160-169', '170-179', '180-189', '190-199', '200-210', '210-220', '220-230', '230-300'];

        function fetchLiveMatches() {
            fetch(`https://cricapi.com/api/v1/currentMatches?apikey=${API_KEY}`)
                .then(response => response.json())
                .then(data => {
                    const chaseSelect = document.querySelector('#chase-analyzer #matchSelect');
                    const matchSelect = document.querySelector('#match-analyzer #matchSelect');
                    chaseSelect.innerHTML = '<option value="">-- Select Live Match --</option>';
                    matchSelect.innerHTML = '<option value="">-- Select Live Match --</option>';
                    data.data.forEach(match => {
                        const option = `<option value="${match.id}">${match.name}</option>`;
                        chaseSelect.innerHTML += option;
                        matchSelect.innerHTML += option;
                    });
                    chaseSelect.value = "64e88ffc-606f-4d4f-b848-310f1ec7a98a";
                    matchSelect.value = "64e88ffc-606f-4d4f-b848-310f1ec7a98a";
                    selectMatch("64e88ffc-606f-4d4f-b848-310f1ec7a98a");
                })
                .catch(err => {
                    document.getElementById('output').textContent = "Error fetching live matches: " + err.message;
                    document.getElementById('match-output').textContent = "Error fetching live matches: " + err.message;
                });
        }

        function selectMatch(matchId) {
            selectedMatchId = matchId;
            lastOver = null;
            lastCompletedRuns = null;
            lastCompletedWickets = null;
            matchScores = { '6over': null, '10over': null, '15over': null, '20over': null };
            currentInnings = 1;
            chaseFirstInningsDone = false;
            chaseTargetRuns = null;
            if (matchId) {
                if (document.getElementById('chase-analyzer').style.display !== 'none') {
                    updateChaseLiveScore();
                } else {
                    updateMatchLiveScore();
                }
            } else {
                document.querySelector('#chase-analyzer #liveScore').textContent = "Live Score: Waiting for match selection...";
                document.querySelector('#match-analyzer #liveScore').textContent = "Live Score: Waiting for match selection...";
            }
        }

        function updateChaseLiveScore() {
            if (!selectedMatchId) return;
            fetch(`https://cricapi.com/api/v1/matches/${selectedMatchId}/ball_by_ball?apikey=${API_KEY}`)
                .then(response => response.json())
                .then(data => {
                    const liveScoreDiv = document.querySelector('#chase-analyzer #liveScore');
                    if (!data.data || data.data.length === 0) {
                        liveScoreDiv.textContent = "Live Score: Match not started or no data available";
                        return;
                    }

                    const latestBall = data.data[data.data.length - 1];
                    const currentOver = parseFloat(latestBall.over);
                    const currentRuns = latestBall.runs;
                    const currentWickets = latestBall.wickets;
                    liveScoreDiv.textContent = `Live Score: ${currentRuns}/${currentWickets} at ${currentOver} overs (Innings ${currentInnings})`;

                    const existingBtn = liveScoreDiv.querySelector('button');
                    if (existingBtn) existingBtn.remove();

                    const lastCompleted = data.data.filter(d => parseFloat(d.over) % 1 === 0).slice(-1)[0];
                    if (!lastCompleted) {
                        const refreshBtn = document.createElement('button');
                        refreshBtn.textContent = "Refresh Score";
                        refreshBtn.onclick = updateChaseLiveScore;
                        liveScoreDiv.appendChild(refreshBtn);
                        return;
                    }

                    const completedOver = parseFloat(lastCompleted.over);
                    if (lastOver !== completedOver) {
                        lastCompletedRuns = lastCompleted.runs;
                        lastCompletedWickets = lastCompleted.wickets;
                        lastOver = completedOver;
                        if (completedOver === 20 && currentInnings === 1) {
                            chaseFirstInningsDone = true;
                            chaseTargetRuns = lastCompletedRuns;
                            chaseScoreRange = getChaseScoreRange(lastCompletedRuns);
                            currentInnings = 2;
                        }
                        processChaseInput(lastCompletedRuns, lastCompletedWickets, completedOver + (currentInnings === 2 ? 20 : 0));
                    }

                    const refreshBtn = document.createElement('button');
                    refreshBtn.textContent = "Refresh Score";
                    refreshBtn.onclick = updateChaseLiveScore;
                    liveScoreDiv.appendChild(refreshBtn);
                })
                .catch(err => {
                    document.getElementById('output').textContent = "Error fetching ball-by-ball data: " + err.message;
                });
        }

        function updateMatchLiveScore() {
            if (!selectedMatchId) return;
            fetch(`https://cricapi.com/api/v1/matches/${selectedMatchId}/ball_by_ball?apikey=${API_KEY}`)
                .then(response => response.json())
                .then(data => {
                    const liveScoreDiv = document.querySelector('#match-analyzer #liveScore');
                    if (!data.data || data.data.length === 0) {
                        liveScoreDiv.textContent = "Live Score: Match not started or no data available";
                        return;
                    }

                    const latestBall = data.data[data.data.length - 1];
                    const currentOver = parseFloat(latestBall.over);
                    const currentRuns = latestBall.runs;
                    const currentWickets = latestBall.wickets;
                    liveScoreDiv.textContent = `Live Score: ${currentRuns}/${currentWickets} at ${currentOver} overs (First Innings)`;

                    const existingBtn = liveScoreDiv.querySelector('button');
                    if (existingBtn) existingBtn.remove();

                    const lastCompleted = data.data.filter(d => parseFloat(d.over) % 1 === 0).slice(-1)[0];
                    if (!lastCompleted) {
                        const refreshBtn = document.createElement('button');
                        refreshBtn.textContent = "Refresh Score";
                        refreshBtn.onclick = updateMatchLiveScore;
                        liveScoreDiv.appendChild(refreshBtn);
                        return;
                    }

                    const completedOver = parseFloat(lastCompleted.over);
                    if (lastOver !== completedOver) {
                        const runs = lastCompleted.runs;
                        const wickets = lastCompleted.wickets;
                        if (completedOver >= 6 && !matchScores['6over']) matchScores['6over'] = `${runs}/${wickets}`;
                        else if (completedOver >= 10 && !matchScores['10over']) matchScores['10over'] = `${runs}/${wickets}`;
                        else if (completedOver >= 15 && !matchScores['15over']) matchScores['15over'] = `${runs}/${wickets}`;
                        else if (completedOver >= 20 && !matchScores['20over']) matchScores['20over'] = `${runs}/${wickets}`;
                        if (completedOver >= 6) {
                            processMatchInput(matchScores['6over'], matchScores['10over'], matchScores['15over'], matchScores['20over']);
                        }
                        lastOver = completedOver;
                    }

                    const refreshBtn = document.createElement('button');
                    refreshBtn.textContent = "Refresh Score";
                    refreshBtn.onclick = updateMatchLiveScore;
                    liveScoreDiv.appendChild(refreshBtn);
                })
                .catch(err => {
                    document.getElementById('match-output').textContent = "Error fetching ball-by-ball data: " + err.message;
                });
        }

        window.onload = function() {
            const savedTheme = localStorage.getItem('theme') || 'classic-mode';
            document.getElementById('themeSelect').value = savedTheme;
            document.getElementById('matchThemeSelect').value = savedTheme;
            document.body.className = savedTheme;
            loadChaseData();
            loadMatchData();
            fetchLiveMatches();
        };

        function loadChaseData() {
            const url = 'https://raw.githubusercontent.com/jayy1704/cricanalyze/main/cricket_data.csv';
            fetch(url)
                .then(response => response.text())
                .then(data => {
                    Papa.parse(data, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            chaseMatches = results.data;
                            chaseFilteredMatches = chaseMatches;
                            document.getElementById('output').textContent = `Data loaded successfully! ${chaseMatches.length} matches found.`;
                        }
                    });
                })
                .catch(err => {
                    document.getElementById('output').textContent = "Error loading data: " + err.message;
                });
        }

        function processChaseInput(runs, wickets, over) {
            const rangeStr = document.getElementById('rangeSelect').value;
            const output = document.getElementById('output');

            if (chaseMatches.length === 0) {
                output.textContent = "Please wait for the data to load from GitHub.";
                return;
            }

            let compareData = chaseMatches;
            const selectedRange = parseChaseRange(rangeStr);
            const overKey = `${over}over`;

            if (over <= 20) {
                if (over === 20) {
                    chaseFirstInningsDone = true;
                    chaseTargetRuns = runs;
                    chaseScoreRange = selectedRange || getChaseScoreRange(runs);
                }
            } else {
                if (!chaseFirstInningsDone) return;
                compareData = chaseFilteredMatches;
            }

            if (selectedRange) {
                compareData = compareData.filter(match => {
                    const score = match['20over'];
                    if (!score) return false;
                    const [matchRuns] = score.split('/').map(Number);
                    return matchRuns >= selectedRange[0] && (selectedRange[1] === Infinity ? true : matchRuns <= selectedRange[1]);
                });
                chaseScoreRange = selectedRange;
            }

            const yearMatches = {};
            let totalMatches = 0;
            let runDifference = null;

            if (over <= 20) {
                compareData.forEach((match, index) => {
                    const score = match[overKey];
                    if (!score) return;
                    const [histRuns, histWickets] = score.split('/').map(Number);
                    if (histRuns === runs && histWickets === wickets) {
                        const year = match['year'];
                        if (!yearMatches[year]) yearMatches[year] = [];
                        yearMatches[year].push({ match, index });
                        totalMatches++;
                    }
                });
            } else {
                runDifference = chaseTargetRuns - runs;
                compareData.forEach((match, index) => {
                    const twentyOverScore = match['20over'];
                    const currentOverScore = match[overKey];
                    if (twentyOverScore && currentOverScore) {
                        const [twentyRuns] = twentyOverScore.split('/').map(Number);
                        const [currentRuns] = currentOverScore.split('/').map(Number);
                        if (twentyRuns - currentRuns === runDifference) {
                            const year = match['year'];
                            if (!yearMatches[year]) yearMatches[year] = [];
                            yearMatches[year].push({ match, index });
                            totalMatches++;
                        }
                    }
                });
            }

            chaseAllYears = [...new Set(Object.keys(yearMatches).map(Number))].sort((a, b) => a - b);
            chaseAllScoreRanges = [];
            compareData.forEach(match => {
                const score = match['20over'];
                if (score) {
                    const [runs] = score.split('/').map(Number);
                    const range = getChaseScoreRange(runs);
                    const rangeStr = range[1] === Infinity ? '200+' : `${range[0]}-${range[1]}`;
                    if (!chaseAllScoreRanges.includes(rangeStr)) chaseAllScoreRanges.push(rangeStr);
                }
            });
            chaseAllScoreRanges.sort((a, b) => parseInt(a.split('-')[0]) - parseInt(b.split('-')[0]));

            let html = `<p>Analysis for ${runs}/${wickets} after Over ${over}<br>`;
            if (over > 20 || selectedRange) {
                html += `20-Over Score Range: ${rangeStr || `${chaseScoreRange[0]}-${chaseScoreRange[1] === Infinity ? '200+' : chaseScoreRange[1]}`}<br>`;
            }
            if (over > 20) html += `Run Difference (20ov - ${over}ov): ${runDifference}<br>`;
            html += `Total matches: ${totalMatches}</p>`;

            if (totalMatches === 0) {
                html += `<p>No matches found with exact score ${runs}/${wickets} after Over ${over}${selectedRange ? ` within ${rangeStr}` : ''}.</p>`;
            } else {
                html += '<div class="filter-group">';
                html += '<button class="year-filter-btn" onclick="openChaseYearFilterModal()">Filter Years</button>';
                html += '<label for="scoreRangeFilter">Filter Score Range:</label>';
                html += '<select id="scoreRangeFilter" onchange="applyChaseFilters()"><option value="">All Score Ranges</option>';
                chaseAllScoreRanges.forEach(range => html += `<option value="${range}">${range}</option>`);
                html += '</select>';
                html += '<label for="resultFilter">Filter Result:</label>';
                html += '<select id="resultFilter" onchange="applyChaseFilters()"><option value="">All Results</option><option value="chased">Chased</option><option value="defend">Defend</option></select>';
                html += '</div>';

                html += '<div class="table-container"><table><thead><tr>';
                const headers = over <= 20 ? 
                    ["Year", ...(over < 6 ? ["6ov"] : []), ...(over < 10 ? ["10ov"] : []), ...(over < 15 ? ["15ov"] : []), "20ov", "Result"] :
                    ["Year", ...(over < 26 ? ["26ov"] : []), ...(over < 30 ? ["30ov"] : []), ...(over < 35 ? ["35ov"] : []), `${over}ov`, "20ov", "40ov", "15ov-6ov", "20ov-6ov", "Result"];
                headers.forEach(header => html += `<th>${header}</th>`);
                html += '</tr></thead><tbody id="tableBody">';

                const sortedRows = [];
                Object.keys(yearMatches).sort().forEach(year => {
                    yearMatches[year].forEach(({ match }) => sortedRows.push({ year, match }));
                });
                sortedRows.sort((a, b) => a.year - b.year);
                chaseLastData = [];
                chaseSelectedYears = chaseAllYears.map(String);

                sortedRows.forEach(({ year, match }) => {
                    const rowData = { Year: year, originalMatch: match };
                    if (over <= 20) {
                        if (over < 6) rowData['6ov'] = match['6over'] || "N/A";
                        if (over < 10) rowData['10ov'] = match['10over'] || "N/A";
                        if (over < 15) rowData['15ov'] = match['15over'] || "N/A";
                        rowData['20ov'] = match['20over'] || "N/A";
                        rowData['Result'] = match['result'] || "unknown";
                    } else {
                        if (over < 26) rowData['26ov'] = match['26over'] || "N/A";
                        if (over < 30) rowData['30ov'] = match['30over'] || "N/A";
                        if (over < 35) rowData['35ov'] = match['35over'] || "N/A";
                        rowData[`${over}ov`] = match[overKey] || "N/A";
                        rowData['20ov'] = match['20over'] || "N/A";
                        rowData['40ov'] = match['40over'] || "N/A";
                        rowData['15ov-6ov'] = calculateChaseDifference(match['15over'], match['6over']);
                        rowData['20ov-6ov'] = calculateChaseDifference(match['20over'], match['6over']);
                        rowData['Result'] = match['result'] || "unknown";
                    }
                    chaseLastData.push(rowData);
                });

                html += generateChaseTableRows(chaseLastData, over, runs, wickets);
                html += '</tbody></table></div>';

                const probabilities = calculateChaseProbabilities(chaseLastData);
                html += `<p>Probability of Chased: ${probabilities.chased}% | Probability of Defend: ${probabilities.defend}%</p>`;
                html += '<button class="back-to-top" onclick="scrollChaseToTop()">Back to Top</button>';
            }

            output.innerHTML = html;
            document.getElementById('viewDetailsBtn').disabled = totalMatches === 0;
            addChaseSortFunctionality();
        }

        function parseChaseRange(rangeStr) {
            if (!rangeStr) return null;
            if (rangeStr === "200+") return [200, Infinity];
            const [min, max] = rangeStr.split('-').map(Number);
            return [min, max];
        }

        function calculateChaseDifference(scoreLater, scoreEarlier) {
            if (!scoreLater || !scoreEarlier) return "N/A";
            const [runsLater, wicketsLater] = scoreLater.split('/').map(Number);
            const [runsEarlier, wicketsEarlier] = scoreEarlier.split('/').map(Number);
            return `${runsLater - runsEarlier}/${wicketsLater - wicketsEarlier}`;
        }

        function calculateChaseProbabilities(data) {
            const validResults = data.filter(row => row.Result.toLowerCase() === 'chased' || row.Result.toLowerCase() === 'defend');
            const totalValid = validResults.length;
            if (totalValid === 0) return { chased: 0, defend: 0 };
            const chasedCount = validResults.filter(row => row.Result.toLowerCase() === 'chased').length;
            return {
                chased: (chasedCount / totalValid * 100).toFixed(2),
                defend: ((totalValid - chasedCount) / totalValid * 100).toFixed(2)
            };
        }

        function isMatchInMatchAnalyzer(chaseMatch) {
            if (!matchLastData || matchLastData.length === 0) return false;
            return matchLastData.some(matchRow => {
                const chaseDetails = chaseMatch.originalMatch;
                const matchDetails = matchRow.match;
                return Object.keys(chaseDetails).every(key => chaseDetails[key] === matchDetails[key]);
            });
        }

        function generateChaseTableRows(data, over, runs, wickets) {
            let html = '';
            data.forEach(row => {
                const overKey = `${over}ov`;
                const isMatch = over <= 20 && row[overKey] && row[overKey].split('/').map(Number)[0] === runs && row[overKey].split('/').map(Number)[1] === wickets;
                const isHighlighted = isMatchInMatchAnalyzer(row);
                html += `<tr ${isMatch ? 'class="highlight"' : ''} ${isHighlighted ? 'class="highlight-match"' : ''}>`;
                Object.entries(row).forEach(([key, value]) => {
                    if (key !== 'originalMatch') html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            return html;
        }

        function applyChaseFilters() {
            const scoreRangeFilter = document.getElementById('scoreRangeFilter').value;
            const resultFilter = document.getElementById('resultFilter').value;
            const [runs, wickets] = chaseLastData.length > 0 ? chaseLastData[0][Object.keys(chaseLastData[0]).find(k => k.includes('ov'))].split('/').map(Number) : [0, 0];
            const over = parseInt(Object.keys(chaseLastData[0]).find(k => k.includes('ov')).replace('ov', ''));
            const filteredData = chaseLastData.filter(row => {
                const yearMatch = chaseSelectedYears.length === 0 || chaseSelectedYears.includes(row.Year.toString());
                const rangeMatch = !scoreRangeFilter || (() => {
                    const [runs] = (row['20ov'] || '0/0').split('/').map(Number);
                    const range = parseChaseRange(scoreRangeFilter);
                    return runs >= range[0] && (range[1] === Infinity ? true : runs <= range[1]);
                })();
                const resultMatch = !resultFilter || row.Result.toLowerCase() === resultFilter;
                return yearMatch && rangeMatch && resultMatch;
            });
            document.getElementById('tableBody').innerHTML = generateChaseTableRows(filteredData, over, runs, wickets);
            const probabilities = calculateChaseProbabilities(filteredData);
            document.getElementById('output').innerHTML = document.getElementById('output').innerHTML.split('<p>Probability')[0] + 
                `<p>Probability of Chased: ${probabilities.chased}% | Probability of Defend: ${probabilities.defend}%</p>` +
                '<button class="back-to-top" onclick="scrollChaseToTop()">Back to Top</button>';
            document.getElementById('viewDetailsBtn').disabled = filteredData.length === 0;
            addChaseSortFunctionality();
        }

        function addChaseSortFunctionality() {
            const table = document.querySelector('#output table');
            if (!table) return;
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const isAscending = header.dataset.sort !== 'asc';
                    rows.sort((a, b) => {
                        const aValue = a.cells[index].textContent;
                        const bValue = b.cells[index].textContent;
                        if (header.textContent === 'Year') return isAscending ? Number(aValue) - Number(bValue) : Number(bValue) - Number(aValue);
                        if (aValue.includes('/') && bValue.includes('/')) {
                            const [runsA] = aValue.split('/').map(Number);
                            const [runsB] = bValue.split('/').map(Number);
                            return isAscending ? runsA - runsB : runsB - runsA;
                        }
                        return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                    });
                    headers.forEach(h => delete h.dataset.sort);
                    header.dataset.sort = isAscending ? 'asc' : 'desc';
                    tbody.innerHTML = '';
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }

        function getChaseScoreRange(runs) {
            if (runs >= 200) return [200, Infinity];
            const rangeStart = Math.floor(runs / 10) * 10;
            return [rangeStart, rangeStart + 9];
        }

        function viewChaseFullMatchDetails() {
            const modal = document.getElementById('fullDetailsModal');
            const outputDiv = document.getElementById('fullDetailsOutput');
            if (!chaseLastData || chaseLastData.length === 0) {
                outputDiv.textContent = "No data available.";
                modal.style.display = 'flex';
                return;
            }
            const scoreRangeFilter = document.getElementById('scoreRangeFilter') ? document.getElementById('scoreRangeFilter').value : '';
            const resultFilter = document.getElementById('resultFilter') ? document.getElementById('resultFilter').value : '';
            const filteredData = chaseLastData.filter(row => {
                const yearMatch = chaseSelectedYears.length === 0 || chaseSelectedYears.includes(row.Year.toString());
                const rangeMatch = !scoreRangeFilter || (() => {
                    const [runs] = (row['20ov'] || '0/0').split('/').map(Number);
                    const range = parseChaseRange(scoreRangeFilter);
                    return runs >= range[0] && (range[1] === Infinity ? true : runs <= range[1]);
                })();
                const resultMatch = !resultFilter || row.Result.toLowerCase() === resultFilter;
                return yearMatch && rangeMatch && resultMatch;
            });
            if (filteredData.length === 0) {
                outputDiv.textContent = "No matches match the current filters.";
            } else {
                const allKeys = [...new Set(filteredData.flatMap(row => Object.keys(row.originalMatch)))];
                let html = '<table><thead><tr>' + allKeys.map(key => `<th>${key}</th>`).join('') + '</tr></thead><tbody>';
                filteredData.forEach(row => {
                    html += '<tr>' + allKeys.map(key => `<td>${row.originalMatch[key] || 'N/A'}</td>`).join('') + '</tr>';
                });
                html += '</tbody></table>';
                outputDiv.innerHTML = html;
            }
            modal.style.display = 'flex';
            addChaseModalSortFunctionality();
        }

        function addChaseModalSortFunctionality() {
            const table = document.querySelector('#fullDetailsOutput table');
            if (!table) return;
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const isAscending = header.dataset.sort !== 'asc';
                    rows.sort((a, b) => {
                        const aValue = a.cells[index].textContent;
                        const bValue = b.cells[index].textContent;
                        if (header.textContent === 'year') return isAscending ? Number(aValue) - Number(bValue) : Number(bValue) - Number(aValue);
                        if (aValue.includes('/') && bValue.includes('/')) {
                            const [runsA] = aValue.split('/').map(Number);
                            const [runsB] = bValue.split('/').map(Number);
                            return isAscending ? runsA - runsB : runsB - runsA;
                        }
                        return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                    });
                    headers.forEach(h => delete h.dataset.sort);
                    header.dataset.sort = isAscending ? 'asc' : 'desc';
                    tbody.innerHTML = '';
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }

        function openChaseYearFilterModal() {
            const modal = document.getElementById('yearFilterModal');
            const checkboxesDiv = document.getElementById('yearCheckboxes');
            let html = '';
            chaseAllYears.forEach(year => {
                const isChecked = chaseSelectedYears.length === 0 || chaseSelectedYears.includes(year.toString());
                html += `<label class="year-checkbox-label"><input type="checkbox" class="year-checkbox" value="${year}" ${isChecked ? 'checked' : ''}>${year}</label>`;
            });
            checkboxesDiv.innerHTML = html;
            modal.style.display = 'flex';
        }

        function closeChaseYearFilterModal() {
            document.getElementById('yearFilterModal').style.display = 'none';
        }

        function applyChaseYearFilter() {
            const yearCheckboxes = document.querySelectorAll('.year-checkbox:checked');
            chaseSelectedYears = Array.from(yearCheckboxes).map(cb => cb.value);
            closeChaseYearFilterModal();
            applyChaseFilters();
        }

        function closeChaseFullDetailsModal() {
            document.getElementById('fullDetailsModal').style.display = 'none';
        }

        function scrollChaseToTop() {
            document.getElementById('output').scrollTop = 0;
        }

        function loadMatchData() {
            const url = 'https://raw.githubusercontent.com/jayy1704/cricanalyze/main/cricket_data.csv';
            fetch(url)
                .then(response => response.text())
                .then(data => {
                    Papa.parse(data, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            matchMatches = results.data;
                            matchAllYears = [...new Set(matchMatches.map(match => match['year']))].sort((a, b) => a - b);
                            matchSelectedYears = matchAllYears.map(String);
                            document.getElementById('match-output').textContent = `Data loaded successfully! ${matchMatches.length} matches found.`;
                        }
                    });
                })
                .catch(err => {
                    document.getElementById('match-output').textContent = "Error loading data: " + err.message;
                });
        }

        function processMatchInput(score6ov, score10ov, score15ov, score20ov) {
            const inputScores = {
                '6over': score6ov ? score6ov.split('/').map(Number) : [null, null],
                '10over': score10ov ? score10ov.split('/').map(Number) : [null, null],
                '15over': score15ov ? score15ov.split('/').map(Number) : [null, null],
                '20over': score20ov ? score20ov.split('/').map(Number) : [null, null],
                '10-6': calculateMatchDifferences(score10ov ? score10ov.split('/')[0] : null, score10ov ? score10ov.split('/')[1] : null, score6ov ? score6ov.split('/')[0] : null, score6ov ? score6ov.split('/')[1] : null),
                '15-10': calculateMatchDifferences(score15ov ? score15ov.split('/')[0] : null, score15ov ? score15ov.split('/')[1] : null, score10ov ? score10ov.split('/')[0] : null, score10ov ? score10ov.split('/')[1] : null),
                '15-6': calculateMatchDifferences(score15ov ? score15ov.split('/')[0] : null, score15ov ? score15ov.split('/')[1] : null, score6ov ? score6ov.split('/')[0] : null, score6ov ? score6ov.split('/')[1] : null),
                '20-6': calculateMatchDifferences(score20ov ? score20ov.split('/')[0] : null, score20ov ? score20ov.split('/')[1] : null, score6ov ? score6ov.split('/')[0] : null, score6ov ? score6ov.split('/')[1] : null),
                '20-10': calculateMatchDifferences(score20ov ? score20ov.split('/')[0] : null, score20ov ? score20ov.split('/')[1] : null, score10ov ? score10ov.split('/')[0] : null, score10ov ? score10ov.split('/')[1] : null),
                '20-15': calculateMatchDifferences(score20ov ? score20ov.split('/')[0] : null, score20ov ? score20ov.split('/')[1] : null, score15ov ? score15ov.split('/')[0] : null, score15ov ? score15ov.split('/')[1] : null)
            };

            const matchedMatches = [];
            matchMatches.forEach(match => {
                const matchScores = {
                    '6over': match['6over'] ? match['6over'].split('/').map(Number) : [null, null],
                    '10over': match['10over'] ? match['10over'].split('/').map(Number) : [null, null],
                    '15over': match['15over'] ? match['15over'].split('/').map(Number) : [null, null],
                    '20over': match['20over'] ? match['20over'].split('/').map(Number) : [null, null]
                };
                const matchDiffs = {
                    '10-6': calculateMatchDifferences(matchScores['10over'][0], matchScores['10over'][1], matchScores['6over'][0], matchScores['6over'][1]),
                    '15-10': calculateMatchDifferences(matchScores['15over'][0], matchScores['15over'][1], matchScores['10over'][0], matchScores['10over'][1]),
                    '15-6': calculateMatchDifferences(matchScores['15over'][0], matchScores['15over'][1], matchScores['6over'][0], matchScores['6over'][1]),
                    '20-6': calculateMatchDifferences(matchScores['20over'][0], matchScores['20over'][1], matchScores['6over'][0], matchScores['6over'][1]),
                    '20-10': calculateMatchDifferences(matchScores['20over'][0], matchScores['20over'][1], matchScores['10over'][0], matchScores['10over'][1]),
                    '20-15': calculateMatchDifferences(matchScores['20over'][0], matchScores['20over'][1], matchScores['15over'][0], matchScores['15over'][1])
                };

                let matchCount = 0;
                const matchesAt = [];
                const matchesWicketsAt = [];

                for (const over in inputScores) {
                    if (['6over', '10over', '15over', '20over'].includes(over)) {
                        const [inputRuns, inputWickets] = inputScores[over];
                        const [matchRuns, matchWickets] = matchScores[over];
                        if (inputRuns !== null && matchRuns === inputRuns) {
                            matchCount++;
                            matchesAt.push(over);
                            if (inputWickets !== null && matchWickets === inputWickets) matchesWicketsAt.push(over);
                        }
                    } else {
                        const inputDiff = inputScores[over];
                        const matchDiff = matchDiffs[over];
                        if (inputDiff && matchDiff) {
                            const [inputRunsDiff, inputWicketsDiff] = inputDiff.split('/').map(Number);
                            const [matchRunsDiff, matchWicketsDiff] = matchDiff.split('/').map(Number);
                            if (inputRunsDiff === matchRunsDiff) {
                                matchCount++;
                                matchesAt.push(over);
                                if (inputWicketsDiff === matchWicketsDiff) matchesWicketsAt.push(over);
                            }
                        }
                    }
                }

                if (matchCount > 0) {
                    matchedMatches.push({
                        match,
                        matchCount,
                        matchesAt,
                        matchesWicketsAt,
                        '6over': match['6over'] || 'N/A',
                        '10over': match['10over'] || 'N/A',
                        '15over': match['15over'] || 'N/A',
                        '20over': match['20over'] || 'N/A',
                        '10-6': matchDiffs['10-6'] || 'N/A',
                        '15-10': matchDiffs['15-10'] || 'N/A',
                        '15-6': matchDiffs['15-6'] || 'N/A',
                        '20-6': matchDiffs['20-6'] || 'N/A',
                        '20-10': matchDiffs['20-10'] || 'N/A',
                        '20-15': matchDiffs['20-15'] || 'N/A',
                        'Result': match['result'] || 'unknown'
                    });
                }
            });

            matchLastData = matchedMatches;
            displayMatchResults(matchLastData);
        }

        function calculateMatchDifferences(runsLater, wicketsLater, runsEarlier, wicketsEarlier) {
            if (runsLater === null || wicketsLater === null || runsEarlier === null || wicketsEarlier === null) return null;
            return `${runsLater - runsEarlier}/${wicketsLater - wicketsEarlier}`;
        }

        function calculateMatchProbabilities(data) {
            const validResults = data.filter(row => row['Result'].toLowerCase() === 'chased' || row['Result'].toLowerCase() === 'defend');
            const totalValid = validResults.length;
            if (totalValid === 0) return { chased: 0, defend: 0 };
            const chasedCount = validResults.filter(row => row['Result'].toLowerCase() === 'chased').length;
            return {
                chased: (chasedCount / totalValid * 100).toFixed(2),
                defend: ((totalValid - chasedCount) / totalValid * 100).toFixed(2)
            };
        }

        function displayMatchResults(data) {
            const output = document.getElementById('match-output');
            let html = `<p>Matches found: ${data.length}</p>`;
            if (data.length === 0) {
                html += '<p>No matches found.</p>';
            } else {
                html += '<div class="filter-group">';
                html += '<button class="year-filter-btn" onclick="openMatchYearFilterModal()">Filter Years</button>';
                html += '<label for="matchFilter">Filter by Matches:</label>';
                html += '<select id="matchFilter" onchange="applyMatchFilters()">';
                html += '<option value="">All Matches</option>';
                for (let i = 1; i <= 10; i++) html += `<option value="${i}">${i} Field${i > 1 ? 's' : ''} Match</option>`;
                html += '</select>';
                html += '<label for="matchScoreRangeFilter">20-Over Score Range:</label>';
                html += '<select id="matchScoreRangeFilter" onchange="applyMatchFilters()">';
                html += '<option value="">All Ranges</option>';
                matchScoreRanges.forEach(range => html += `<option value="${range}">${range}</option>`);
                html += '</select>';
                html += '</div>';

                html += '<div class="table-container"><table><thead><tr>';
                const headers = ['Year', '6ov', '10ov', '15ov', '20ov', '10-6', '15-10', '15-6', '20-6', '20-10', '20-15', 'Result'];
                headers.forEach(header => html += `<th>${header}</th>`);
                html += '</tr></thead><tbody id="matchTableBody">';

                html += generateMatchTableRows(data);
                html += '</tbody></table></div>';

                const probabilities = calculateMatchProbabilities(data);
                html += `<p id="matchProbability">Chased: ${probabilities.chased}% | Defended: ${probabilities.defend}%</p>`;
                html += '<button class="back-to-top" onclick="scrollMatchToTop()">Back to Top</button>';
            }

            output.innerHTML = html;
            document.getElementById('matchSubmitBtn').disabled = data.length === 0;
            addMatchSortFunctionality();
        }

        function generateMatchTableRows(data) {
            return data.map(row => `
                <tr>
                    <td>${row.match['year']}</td>
                    <td class="${row.matchesAt.includes('6over') ? (row.matchesWicketsAt.includes('6over') ? 'match-6ov-wickets' : 'match-6ov') : ''}">${row['6over']}</td>
                    <td class="${row.matchesAt.includes('10over') ? (row.matchesWicketsAt.includes('10over') ? 'match-10ov-wickets' : 'match-10ov') : ''}">${row['10over']}</td>
                    <td class="${row.matchesAt.includes('15over') ? (row.matchesWicketsAt.includes('15over') ? 'match-15ov-wickets' : 'match-15ov') : ''}">${row['15over']}</td>
                    <td class="${row.matchesAt.includes('20over') ? (row.matchesWicketsAt.includes('20over') ? 'match-20ov-wickets' : 'match-20ov') : ''}">${row['20over']}</td>
                    <td class="${row.matchesAt.includes('10-6') ? (row.matchesWicketsAt.includes('10-6') ? 'match-10-6-wickets' : 'match-10-6') : ''}">${row['10-6']}</td>
                    <td class="${row.matchesAt.includes('15-10') ? (row.matchesWicketsAt.includes('15-10') ? 'match-15-10-wickets' : 'match-15-10') : ''}">${row['15-10']}</td>
                    <td class="${row.matchesAt.includes('15-6') ? (row.matchesWicketsAt.includes('15-6') ? 'match-15-6-wickets' : 'match-15-6') : ''}">${row['15-6']}</td>
                    <td class="${row.matchesAt.includes('20-6') ? (row.matchesWicketsAt.includes('20-6') ? 'match-20-6-wickets' : 'match-20-6') : ''}">${row['20-6']}</td>
                    <td class="${row.matchesAt.includes('20-10') ? (row.matchesWicketsAt.includes('20-10') ? 'match-20-10-wickets' : 'match-20-10') : ''}">${row['20-10']}</td>
                    <td class="${row.matchesAt.includes('20-15') ? (row.matchesWicketsAt.includes('20-15') ? 'match-20-15-wickets' : 'match-20-15') : ''}">${row['20-15']}</td>
                    <td>${row['Result']}</td>
                </tr>
            `).join('');
        }

        function applyMatchFilters() {
            const matchFilter = document.getElementById('matchFilter').value;
            const scoreRangeFilter = document.getElementById('matchScoreRangeFilter').value;
            const filteredData = matchLastData.filter(row => {
                const yearMatch = matchSelectedYears.length === 0 || matchSelectedYears.includes(row.match['year'].toString());
                const matchCountMatch = !matchFilter || row.matchCount === parseInt(matchFilter);
                const rangeMatch = !scoreRangeFilter || (() => {
                    const [runs] = (row['20over'] || '0/0').split('/').map(Number);
                    const [min, max] = scoreRangeFilter.split('-').map(Number);
                    return runs >= min && runs <= max;
                })();
                return yearMatch && matchCountMatch && rangeMatch;
            });

            const output = document.getElementById('match-output');
            let html = `<p>Matches found: ${filteredData.length}</p>`;
            if (filteredData.length === 0) {
                html += '<p>No matches found with current filters.</p>';
            } else {
                html += '<div class="filter-group">';
                html += '<button class="year-filter-btn" onclick="openMatchYearFilterModal()">Filter Years</button>';
                html += '<label for="matchFilter">Filter by Matches:</label>';
                html += '<select id="matchFilter" onchange="applyMatchFilters()">';
                html += `<option value="">All Matches</option>`;
                for (let i = 1; i <= 10; i++) html += `<option value="${i}" ${matchFilter === i.toString() ? 'selected' : ''}>${i} Field${i > 1 ? 's' : ''} Match</option>`;
                html += '</select>';
                html += '<label for="matchScoreRangeFilter">20-Over Score Range:</label>';
                html += '<select id="matchScoreRangeFilter" onchange="applyMatchFilters()">';
                html += `<option value="">All Ranges</option>`;
                matchScoreRanges.forEach(range => html += `<option value="${range}" ${scoreRangeFilter === range ? 'selected' : ''}>${range}</option>`);
                html += '</select>';
                html += '</div>';

                html += '<div class="table-container"><table><thead><tr>';
                const headers = ['Year', '6ov', '10ov', '15ov', '20ov', '10-6', '15-10', '15-6', '20-6', '20-10', '20-15', 'Result'];
                headers.forEach(header => html += `<th>${header}</th>`);
                html += '</tr></thead><tbody id="matchTableBody">';

                html += generateMatchTableRows(filteredData);
                html += '</tbody></table></div>';

                const probabilities = calculateMatchProbabilities(filteredData);
                html += `<p id="matchProbability">Chased: ${probabilities.chased}% | Defended: ${probabilities.defend}%</p>`;
                html += '<button class="back-to-top" onclick="scrollMatchToTop()">Back to Top</button>';
            }

            output.innerHTML = html;
            document.getElementById('matchSubmitBtn').disabled = filteredData.length === 0;
            addMatchSortFunctionality();
        }

        function addMatchSortFunctionality() {
            const table = document.querySelector('#match-output table');
            if (!table) return;
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const isAscending = header.dataset.sort !== 'asc';
                    rows.sort((a, b) => {
                        const aValue = a.cells[index].textContent;
                        const bValue = b.cells[index].textContent;
                        if (index === 0) return isAscending ? Number(aValue) - Number(bValue) : Number(bValue) - Number(aValue);
                        if (index >= 1 && index <= 10) {
                            const aNum = aValue === 'N/A' ? -Infinity : parseInt(aValue.split('/')[0]);
                            const bNum = bValue === 'N/A' ? -Infinity : parseInt(bValue.split('/')[0]);
                            return isAscending ? aNum - bNum : bNum - aNum;
                        }
                        return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                    });
                    headers.forEach(h => delete h.dataset.sort);
                    header.dataset.sort = isAscending ? 'asc' : 'desc';
                    tbody.innerHTML = '';
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }

        function openMatchYearFilterModal() {
            const modal = document.getElementById('matchYearFilterModal');
            const checkboxesDiv = document.getElementById('matchYearCheckboxes');
            checkboxesDiv.innerHTML = matchAllYears.map(year => `
                <label class="year-checkbox-label">
                    <input type="checkbox" class="year-checkbox" value="${year}" ${matchSelectedYears.includes(year.toString()) ? 'checked' : ''}>${year}
                </label>
            `).join('');
            modal.style.display = 'flex';
        }

        function closeMatchYearFilterModal() {
            document.getElementById('matchYearFilterModal').style.display = 'none';
        }

        function applyMatchYearFilter() {
            const yearCheckboxes = document.querySelectorAll('#matchYearCheckboxes .year-checkbox:checked');
            matchSelectedYears = Array.from(yearCheckboxes).map(cb => cb.value);
            closeMatchYearFilterModal();
            applyMatchFilters();
        }

        function viewMatchFullMatchDetails() {
            const modal = document.getElementById('matchFullDetailsModal');
            const outputDiv = document.getElementById('matchFullDetailsOutput');
            const matchFilter = document.getElementById('matchFilter').value;
            const scoreRangeFilter = document.getElementById('matchScoreRangeFilter').value;
            const filteredData = matchLastData.filter(row => {
                const yearMatch = matchSelectedYears.length === 0 || matchSelectedYears.includes(row.match['year'].toString());
                const matchCountMatch = !matchFilter || row.matchCount === parseInt(matchFilter);
                const rangeMatch = !scoreRangeFilter || (() => {
                    const [runs] = (row['20over'] || '0/0').split('/').map(Number);
                    const [min, max] = scoreRangeFilter.split('-').map(Number);
                    return runs >= min && runs <= max;
                })();
                return yearMatch && matchCountMatch && rangeMatch;
            });
            if (filteredData.length === 0) {
                outputDiv.textContent = "No matches match the current filters.";
            } else {
                const allKeys = [...new Set(filteredData.flatMap(row => Object.keys(row.match)))];
                let html = '<table><thead><tr>' + allKeys.map(key => `<th>${key}</th>`).join('') + '</tr></thead><tbody>';
                html += filteredData.map(row => '<tr>' + allKeys.map(key => `<td>${row.match[key] || 'N/A'}</td>`).join('') + '</tr>').join('');
                html += '</tbody></table>';
                outputDiv.innerHTML = html;
            }
            modal.style.display = 'flex';
            addMatchModalSortFunctionality();
        }

        function addMatchModalSortFunctionality() {
            const table = document.querySelector('#matchFullDetailsOutput table');
            if (!table) return;
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const isAscending = header.dataset.sort !== 'asc';
                    rows.sort((a, b) => {
                        const aValue = a.cells[index].textContent;
                        const bValue = b.cells[index].textContent;
                        if (aValue.includes('/') && bValue.includes('/')) {
                            const aNum = aValue === 'N/A' ? -Infinity : parseInt(aValue.split('/')[0]);
                            const bNum = bValue === 'N/A' ? -Infinity : parseInt(bValue.split('/')[0]);
                            return isAscending ? aNum - bNum : bNum - aNum;
                        }
                        return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                    });
                    headers.forEach(h => delete h.dataset.sort);
                    header.dataset.sort = isAscending ? 'asc' : 'desc';
                    tbody.innerHTML = '';
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }

        function closeMatchFullDetailsModal() {
            document.getElementById('matchFullDetailsModal').style.display = 'none';
        }

        function scrollMatchToTop() {
            document.getElementById('match-output').scrollTop = 0;
        }
    </script>
</body>
</html>